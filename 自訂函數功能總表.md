# 自訂函數功能總表

## ?? 專案資訊
- **專案名稱**：113 學年度工科賽電腦修護職類第二站 PC 端程式
- **開發語言**：Visual Basic .NET 2022
- **目標框架**：.NET 8.0 Windows Forms
- **版本**：v2.2
- **崗位號碼**：01

---

## ?? 目錄
1. [Form1.vb - 主程式](#1-form1vb---主程式)
2. [SerialPortManager.vb - 序列埠管理](#2-serialportmanagervb---序列埠管理)
3. [ComPortWatcher.vb - COM Port 監控](#3-comportwatchervb---com-port-監控)
4. [CpuLoadProvider.vb - 效能監控](#4-cpuloadprovidervb---效能監控)
5. [EepromService.vb - EEPROM 服務](#5-eepromservicevb---eeprom-服務)
6. [BleProtocol.vb - 藍牙通訊協定](#6-bleprotocolvb---藍牙通訊協定)
7. [LedDisplayManager.vb - LED 顯示管理](#7-leddisplaymanagervb---led-顯示管理)
8. [LedSyncService.vb - LED 同步服務](#8-ledsyncservicevb---led-同步服務)
9. [TitleService.vb - 標題服務](#9-titleservicevb---標題服務)

---

## 1. Form1.vb - 主程式

### 事件處理函數

| 函數名稱 | 類型 | 功能說明 | 觸發時機 |
|---------|------|---------|---------|
| `Form1_Load` | Private Sub | 程式啟動初始化 | 表單載入時 |
| `btnOpenPort_Click` | Private Sub | 開啟 COM Port 連線 | 點擊 Open 按鈕 |
| `btnClosePort_Click` | Private Sub | 關閉 COM Port 連線 | 點擊 Close 按鈕 |
| `btnRefreshPorts_Click` | Private Sub | 手動刷新 COM Port 清單 | 點擊 Refresh 按鈕 |
| `btnStartCpu_Click` | Private Sub | 啟動 CPU 監控 | 點擊 Start CPU 按鈕 |
| `btnStopCpu_Click` | Private Sub | 停止 CPU 監控並重置 LED | 點擊 Stop CPU 按鈕 |
| `btnStartRam_Click` | Private Sub | 啟動 RAM 監控 | 點擊 Start RAM 按鈕 |
| `btnStopRam_Click` | Private Sub | 停止 RAM 監控並重置 LED | 點擊 Stop RAM 按鈕 |
| `btnWrite_Click` | Private Sub | 驗證並寫入 EEPROM 資料 | 點擊 Write 按鈕 |
| `btnExit_Click` | Private Sub | 安全退出程式 | 點擊 Exit 按鈕 |
| `timerCpu_Tick` | Private Sub | CPU 使用率監控與資料傳送 | 每秒觸發 |
| `timerRam_Tick` | Private Sub | RAM 使用率監控與資料傳送 | 每秒觸發 |
| `timerPortCheck_Tick` | Private Sub | 定時檢查 COM Port 變化 | 每 2 秒觸發 |
| `Form1_FormClosing` | Private Sub | 資源清理與程式關閉 | 表單關閉時 |

### 核心功能函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `InitializeServices` | Private Sub | 初始化所有核心服務模組 | 無 | 無 |
| `InitializeUI` | Private Sub | 設定 UI 控件初始狀態 | 無 | 無 |
| `RefreshComPorts` | Private Sub | 刷新 COM Port 下拉選單 | 無 | 無 |
| `UpdateConnectionStatus` | Private Sub | 更新連線狀態與控件狀態 | `connected As Boolean` | 無 |

### 事件回調函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `OnConnectionStatusChanged` | Private Sub | 處理連線狀態變更事件 | `connected As Boolean` | 無 |
| `OnSerialDataReceived` | Private Sub | 處理序列埠資料接收事件 | `data As Byte()` | 無 |
| `OnPortsChanged` | Private Sub | 處理 COM Port 變更事件 | `ports As List(Of String)` | 無 |

---

## 2. SerialPortManager.vb - 序列埠管理

### 公開函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `New` | Constructor | 初始化序列埠設定（9600, 8, N, 1） | 無 | 無 |
| `OpenPort` | Public Function | 開啟指定的 COM Port 並發送連線字元 'c' | `portName As String` | `Boolean` |
| `ClosePort` | Public Sub | 關閉 COM Port 並發送斷線字元 'b' | 無 | 無 |
| `SendData` | Public Sub | 透過序列埠傳送位元組陣列 | `data As Byte()` | 無 |
| `Dispose` | Public Sub | 釋放序列埠資源 | 無 | 無 |

### 屬性

| 屬性名稱 | 類型 | 功能說明 | 存取 |
|---------|------|---------|------|
| `IsConnected` | ReadOnly Property | 取得目前連線狀態 | 唯讀 |

### 事件

| 事件名稱 | 參數 | 功能說明 |
|---------|------|---------|
| `DataReceived` | `data As Byte()` | 序列埠接收到資料時觸發 |
| `ConnectionStatusChanged` | `connected As Boolean` | 連線狀態變更時觸發 |

### 私有函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `SerialPort_DataReceived` | Private Sub | 處理序列埠資料接收事件 | `sender, e` | 無 |

---

## 3. ComPortWatcher.vb - COM Port 監控

### 公開函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `New` | Constructor | 初始化 COM Port 監控器 | 無 | 無 |
| `GetAvailablePorts` | Public Function | 取得系統所有可用的 COM Port | 無 | `List(Of String)` |
| `StartWatching` | Public Sub | 啟動 COM Port 熱插拔監控 | 無 | 無 |
| `StopWatching` | Public Sub | 停止 COM Port 監控 | 無 | 無 |

### 事件

| 事件名稱 | 參數 | 功能說明 |
|---------|------|---------|
| `PortsChanged` | `ports As List(Of String)` | COM Port 插拔變化時觸發 |

### 私有函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `OnDeviceChanged` | Private Sub | 處理裝置變更事件 | `sender, e` | 無 |

---

## 4. CpuLoadProvider.vb - 效能監控

### 公開函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `New` | Constructor | 初始化 CPU 和 RAM 效能計數器 | 無 | 無 |
| `GetCpuUsage` | Public Function | 取得目前 CPU 使用率 | 無 | `Single` (0-100) |
| `GetMemoryUsage` | Public Function | 取得目前記憶體使用率 | 無 | `Single` (0-100) |
| `GetColorForCpuUsage` | Public Function | 根據 CPU 使用率判斷顏色 | `usage As Single` | `Color` |
| `GetColorForRamUsage` | Public Function | 根據 RAM 使用率判斷顏色 | `usage As Single` | `Color` |
| `Dispose` | Public Sub | 釋放效能計數器資源 | 無 | 無 |

### 顏色判斷規則

| 使用率範圍 | 返回顏色 | RGB 值 |
|-----------|---------|--------|
| 0% ~ 50% | 綠色 (Lime) | (0, 255, 0) |
| 51% ~ 84% | 黃色 (Yellow) | (255, 255, 0) |
| ? 85% | 紅色 (Red) | (255, 0, 0) |

---

## 5. EepromService.vb - EEPROM 服務

### 公開函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `ValidateBinaryInput` | Public Function | 驗證輸入是否為 4 位元二進位 | `input As String` | `Boolean` |
| `BinaryToDecimal` | Public Function | 將二進位字串轉換為十進位 | `binaryStr As String` | `Integer` (0-15 或 -1) |
| `CreateEepromPacket` | Public Function | 建立 EEPROM 寫入封包 | `decimalValue As Byte` | `Byte()` |

### 私有函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `CalculateChecksum` | Private Function | 計算封包校驗碼 | `data As Byte()`, `startIndex`, `length` | `Byte` |

### 封包格式

```
[SOF] [CMD] [LEN] [Data] [CHK] [EOF]
0xAA  0x20  0x01  value  sum   0x55
```

---

## 6. BleProtocol.vb - 藍牙通訊協定

### 常數定義

| 常數名稱 | 值 | 功能說明 |
|---------|-----|---------|
| `CMD_OPEN` | 0x01 | 開啟連線命令 |
| `CMD_CLOSE` | 0x02 | 關閉連線命令 |
| `CMD_CPU_LOAD` | 0x10 | CPU Loading 命令 |
| `CMD_EEPROM` | 0x20 | EEPROM 寫入命令 |
| `CMD_LED_UPDATE` | 0x10 | LED 更新命令 |
| `SOF` | 0xAA | 起始字元 |
| `EOF` | 0x55 | 結束字元 |

### 公開函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `CreateCpuLoadPacket` | Public Function | 建立 CPU Loading ASCII 封包 | `cpuUsage As Byte`, `color As Color` | `Byte()` |
| `CreateEepromPacket` | Public Function | 建立 EEPROM 寫入封包（二進位） | `value As Byte` | `Byte()` |
| `ParseLedUpdatePacket` | Public Function | 解析 LED 更新封包 | `buffer As Byte()`, `ByRef ledColors() As Color` | `Boolean` |
| `ColorToHexString` | Public Shared Function | 將顏色轉換為 16 進位字串 | `color As Color` | `String` (RRGGBB) |
| `HexStringToColor` | Public Shared Function | 將 16 進位字串轉換為顏色 | `hexString As String` | `Color` |

### 私有函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `CalculateChecksum` | Private Function | 計算封包校驗碼 | `data As Byte()`, `startIndex`, `length` | `Byte` |

### 封包格式

#### CPU/RAM Loading（ASCII 格式，v2.2）
```
格式：LOAD數值\n
範例：LOAD45.2\n
```

#### EEPROM 寫入（二進位格式）
```
[SOF] [CMD] [LEN] [Data] [CHK] [EOF]
0xAA  0x20  0x01  value  sum   0x55
```

#### LED 更新接收（二進位格式）
```
[SOF] [CMD] [LEN] [LED0_RGB] ... [LED7_RGB] [CHK] [EOF]
0xAA  0x10  0x18  R G B ...     sum   0x55
```

---

## 7. LedDisplayManager.vb - LED 顯示管理

### 常數定義

| 常數名稱 | 值 | 功能說明 |
|---------|-----|---------|
| `LED_SIZE` | 22 | LED 燈號直徑（像素） |

### 公開函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `New` | Constructor | 初始化 8 顆 LED 顏色陣列 | 無 | 無 |
| `InitializeLeds` | Public Sub | 在容器中建立 8 顆圓形 LED 控件 | `container`, `startX`, `startY`, `spacing` | 無 |
| `UpdateLed` | Public Sub | 更新單一 LED 燈號顏色 | `index As Integer`, `color As Color` | 無 |
| `UpdateAllLeds` | Public Sub | 更新所有 LED 燈號為相同顏色 | `color As Color` | 無 |
| `UpdateLedsFromArray` | Public Sub | 從陣列更新所有 LED 燈號顏色 | `colors() As Color` | 無 |
| `TurnOffAllLeds` | Public Sub | 關閉所有 LED（設為黑色） | 無 | 無 |
| `Dispose` | Public Sub | 釋放所有 LED 圖形資源 | 無 | 無 |

### 私有函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `DrawLed` | Private Sub | 繪製單一 LED 圓形燈號 | `index As Integer`, `color As Color` | 無 |

### 繪製特效

- ? 反鋸齒圓形
- ? 灰色邊框
- ? 梯度漸層效果（亮燈時）
- ? 中心高光效果

---

## 8. LedSyncService.vb - LED 同步服務

### 公開函數

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `New` | Constructor | 初始化 LED 同步服務 | `ledDisplayManager As LedDisplayManager` | 無 |
| `ProcessReceivedData` | Public Sub | 處理從 Arduino 接收的 LED 資料 | `data As Byte()` | 無 |
| `SyncCpuLoadingColor` | Public Sub | 同步 CPU Loading 顏色到所有 LED | `color As Color` | 無 |
| `SyncRamLoadingColor` | Public Sub | 同步 RAM Loading 顏色到所有 LED | `color As Color` | 無 |
| `ResetLeds` | Public Sub | 重置所有 LED 為黑色 | 無 | 無 |

### 同步規則

| 情境 | LED 顯示 |
|------|---------|
| CPU 監控啟動 | 根據使用率顯示綠/黃/紅色 |
| RAM 監控啟動 | 根據使用率顯示綠/黃/紅色 |
| 停止監控 | 全部重置為黑色 |
| 斷線 | 全部重置為黑色 |
| 接收 Arduino 資料 | 依接收的 RGB 值更新 |

---

## 9. TitleService.vb - 標題服務

### 共享函數（靜態）

| 函數名稱 | 類型 | 功能說明 | 參數 | 返回值 |
|---------|------|---------|------|--------|
| `GetFormTitle` | Public Shared Function | 取得視窗標題列文字 | `stationNumber As String` | `String` |
| `GetBluetoothModuleName` | Public Shared Function | 計算藍牙模組名稱 | `stationNumber As String` | `String` |

### 命名規則

#### 藍牙模組名稱計算邏輯

1. 將崗位號碼轉為 8 位元二進位
2. 取最右位判斷奇偶
3. 取後 4 位作為 BBBB

**範例：**
- 崗位 01 → 00000001 → 奇數 → `ODD-01-0001`
- 崗位 02 → 00000010 → 偶數 → `EVEN-02-0010`

---

## ?? 函數統計總覽

| 模組 | 公開函數 | 私有函數 | 事件處理 | 靜態函數 | 總計 |
|------|---------|---------|---------|---------|------|
| Form1.vb | 0 | 17 | 13 | 0 | 30 |
| SerialPortManager.vb | 5 | 1 | 0 | 0 | 6 |
| ComPortWatcher.vb | 4 | 1 | 0 | 0 | 5 |
| CpuLoadProvider.vb | 6 | 0 | 0 | 0 | 6 |
| EepromService.vb | 3 | 1 | 0 | 0 | 4 |
| BleProtocol.vb | 5 | 1 | 0 | 2 | 8 |
| LedDisplayManager.vb | 7 | 1 | 0 | 0 | 8 |
| LedSyncService.vb | 5 | 0 | 0 | 0 | 5 |
| TitleService.vb | 0 | 0 | 0 | 2 | 2 |
| **總計** | **35** | **22** | **13** | **4** | **74** |

---

## ?? 資料流程圖

```
使用者操作 → Form1 事件處理
               ↓
    ┌──────────┴──────────┐
    ↓                     ↓
SerialPortManager    各服務模組
    ↓                     ↓
    ├→ BleProtocol       ├→ CpuLoadProvider
    ├→ EepromService     ├→ LedSyncService
    ├→ ComPortWatcher    └→ LedDisplayManager
    ↓
Arduino 端 ←→ PC 端
    ↓           ↓
WS2812 LED    UI 顯示
```

---

## ?? 使用範例

### 範例 1：開啟 COM Port
```vb
' 在 Form1 中
Private Sub btnOpenPort_Click(sender As Object, e As EventArgs)
    Dim selectedPort As String = cmbComPorts.SelectedItem.ToString()
    If serialManager.OpenPort(selectedPort) Then
        ' 連線成功，UI 會自動透過事件更新
    End If
End Sub
```

### 範例 2：監控 CPU Loading
```vb
' 在計時器中
Private Sub timerCpu_Tick(sender As Object, e As EventArgs)
    ' 取得 CPU 使用率
    Dim cpuUsage = cpuProvider.GetCpuUsage()
    
    ' 判斷顏色
    Dim cpuColor = cpuProvider.GetColorForCpuUsage(cpuUsage)
    
    ' 同步更新 LED
    ledSync.SyncCpuLoadingColor(cpuColor)
    
    ' 傳送資料至 Arduino
    Dim message = "LOAD" & cpuUsage.ToString("F1") & vbLf
    serialManager.SendData(Encoding.ASCII.GetBytes(message))
End Sub
```

### 範例 3：驗證並寫入 EEPROM
```vb
' 在 Write 按鈕中
Private Sub btnWrite_Click(sender As Object, e As EventArgs)
    Dim input = txtBinaryInput.Text.Trim()
    
    ' 驗證格式
    If eepromService.ValidateBinaryInput(input) Then
        ' 轉換為十進位
        Dim decValue = eepromService.BinaryToDecimal(input)
        
        ' 建立封包
        Dim packet = bleProtocol.CreateEepromPacket(CByte(decValue))
        
        ' 傳送至 Arduino
        serialManager.SendData(packet)
    End If
End Sub
```

---

## ?? 關鍵功能對應表

| 功能需求 | 對應模組 | 主要函數 |
|---------|---------|---------|
| P1 - 標題列顯示 | TitleService | `GetFormTitle` |
| P2 - 藍牙名稱 | TitleService | `GetBluetoothModuleName` |
| P3 - COM Port 偵測 | ComPortWatcher | `GetAvailablePorts`, `StartWatching` |
| P4 - 開啟連線 | SerialPortManager | `OpenPort` |
| P5 - 關閉連線 | SerialPortManager | `ClosePort` |
| P6 - 連線狀態 | Form1 | `UpdateConnectionStatus` |
| P7 - CPU 監控 | CpuLoadProvider | `GetCpuUsage`, `GetColorForCpuUsage` |
| P8 - 輸入驗證 | EepromService | `ValidateBinaryInput` |
| P9 - EEPROM 寫入 | BleProtocol, EepromService | `CreateEepromPacket` |
| P10 - 退出程式 | Form1 | `btnExit_Click`, `Form1_FormClosing` |
| P11 - 資訊同步 | Form1 | `timerCpu_Tick`, `timerRam_Tick` |
| P12 - LED 同步 | LedSyncService, LedDisplayManager | `SyncCpuLoadingColor`, `UpdateAllLeds` |

---

## ?? 注意事項

1. **跨執行緒呼叫**：序列埠事件在不同執行緒，需使用 `Invoke` 切換到 UI 執行緒
2. **資源釋放**：程式結束時必須呼叫各模組的 `Dispose` 方法
3. **錯誤處理**：所有 Try-Catch 區塊都有適當的錯誤處理
4. **顏色規則**：CPU/RAM 使用相同的顏色判斷規則
5. **通訊格式**：v2.2 版本 CPU/RAM 使用 ASCII 格式，EEPROM 使用二進位格式

---

**文件版本**：v2.2  
**建立日期**：2025-01-XX  
**最後更新**：2025-01-XX  
**文件狀態**：? 完整  
**程式版本**：v2.2

---

*本文件涵蓋專案中所有自訂函數，共 74 個函數，分布於 9 個模組檔案中。*
